<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HARSH: Quantum Core + Code + Sandbox</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap');

        :root {
            --bg-core: #070710;
            --bg-panel: #0e0e1a;
            --border: #28283f;
            --accent: #6ee7ff;
            --text-primary: #eef1f5;
            --text-secondary: #a8b0c0;
            --code-bg: #0b0b15;
            --user-bubble: #1c1c30;
        }

        @keyframes subtlePulse {
            0% { box-shadow: 0 0 100px rgba(110, 231, 255, 0.04); }
            50% { box-shadow: 0 0 120px rgba(110, 231, 255, 0.08); }
            100% { box-shadow: 0 0 100px rgba(110, 231, 255, 0.04); }
        }

        body {
            background-color: var(--bg-core);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            height: 100dvh;
            display: flex;
            overflow: hidden;
            background-image: radial-gradient(circle at center, rgba(110, 231, 255, 0.03) 0%, transparent 70%);
            animation: subtlePulse 20s infinite ease-in-out;
        }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #404058; border-radius: 10px; }
        ::-webkit-scrollbar-corner { background: transparent; }

        .prose { font-size: 0.95rem; line-height: 1.6; width: 100%; max-width: none; }
        .prose p { margin-bottom: 1rem; color: var(--text-primary); }
        .prose h1, .prose h2, .prose h3 { color: #fff; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid var(--border); padding-bottom: 4px; }
        .prose ul, .prose ol { color: var(--text-secondary); padding-left: 1.5rem; margin-bottom: 1rem;}
        .prose li::marker { color: var(--accent); }
        .prose strong { color: #fff; font-weight: 700; }
        .prose a { color: var(--accent); text-decoration: none; border-bottom: 1px solid var(--accent); transition: color 0.2s, border-bottom 0.2s; }
        .prose a:hover { color: #fff; border-bottom: 2px solid var(--accent); }
        
        .prose pre {
            background: var(--code-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin: 1.2rem 0;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.7); 
            position: relative;
            max-height: 60vh; 
            overflow: auto;       
            padding: 0;           
        }
        
        .code-header {
            background: #141426;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
            position: sticky;
            top: 0; left: 0; right: 0; z-index: 10;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0.6rem 1.2rem;
            border-radius: 12px 12px 0 0;
            backdrop-filter: blur(8px); 
        }
        
        .prose pre code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.7;
            background: transparent;
            padding: 1.2rem;
            display: block;
            min-width: 100%; 
        }

        @keyframes floatUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .msg-anim { animation: floatUp 0.6s cubic-bezier(0.25, 0.8, 0.5, 1) forwards; }
        
        .dot-pulse { background: var(--accent); animation: blink 1.4s infinite; width: 5px; height: 5px; border-radius: 50%; box-shadow: 0 0 5px var(--accent); }
        @keyframes blink { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

        .input-container {
            background: var(--bg-panel);
            border-radius: 10px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 30px rgba(0,0,0,0.6), 0 0 0 1px rgba(110, 231, 255, 0.15);
            transition: all 0.3s ease;
        }
        .input-container:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(110, 231, 255, 0.4), 0 0 30px rgba(110, 231, 255, 0.3);
        }

        #user-input {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.95rem;
            color: var(--text-primary);
            text-shadow: 0 0 1px rgba(110, 231, 255, 0.7); 
        }
        
        .thinking-badge {
            background: rgba(110, 231, 255, 0.1); 
            color: var(--accent);
            border: 1px solid rgba(110, 231, 255, 0.4);
            padding: 3px 8px;
            font-size: 0.75rem;
            display: inline-flex; align-items: center; gap: 6px;
            border-radius: 9999px;
            margin-bottom: 6px;
            font-weight: 500;
        }
        
        .user-message-bubble {
            background: var(--user-bubble);
            color: var(--text-primary); 
            border: 1px solid #303040; 
            box-shadow: inset 0 0 8px rgba(110, 231, 255, 0.08);
            margin-top: 4px; 
            border-radius: 10px;
        }

        .header-footer-bg { background-color: var(--bg-core); border-color: var(--border); }
        .prompt-header { background: #10101f; border-radius: 10px 10px 0 0; border-color: var(--border); }
        .ai-avatar { background-image: linear-gradient(135deg, var(--accent), #4dd0e1); box-shadow: 0 0 15px rgba(110, 231, 255, 0.6); }
        .landing-card {
            background: var(--bg-panel);
            border: 2px solid var(--border);
            border-radius: 40px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(110, 231, 255, 0.1);
        }

        .three-pane-layout {
            display: flex;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .history-pane {
            width: 25%;
            min-width: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
        }

        .chat-pane {
            width: 50%;
            min-width: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
        }

        .code-pane {
            width: 25%;
            min-width: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .pane-header {
            background: #141426;
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .pane-title {
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 2rem;
        }

        .navbar-harsh-icon {
            font-size: 2.5rem !important;
            color: var(--accent);
            filter: drop-shadow(0 0 10px rgba(110, 231, 255, 0.8));
        }

        .pane-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 0.85rem;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: auto;
        }

        .btn-primary {
            background: var(--accent);
            color: #000;
            box-shadow: 0 4px 12px rgba(110, 231, 255, 0.4);
            border: 2px solid transparent;
        }

        .btn-primary:hover {
            background: #4dd0e1;
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(110, 231, 255, 0.6);
        }

        .btn-secondary {
            background: var(--bg-panel);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(110, 231, 255, 0.2);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 2px solid rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
        }

        .run-btn {
            background: #1c1c2b;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            font-size: 0.8rem;
        }

        .run-btn:hover {
            background: rgba(110, 231, 255, 0.15);
            color: var(--accent);
            border-color: var(--accent);
            box-shadow: 0 0 10px rgba(110, 231, 255, 0.3);
        }

        .icon-enhanced {
            font-size: 1.5rem;
            filter: drop-shadow(0 0 5px rgba(110, 231, 255, 0.5));
        }
        
        .code-editor-icon {
            font-size: 1.6rem;
            color: #6ee7ff;
            filter: drop-shadow(0 0 10px rgba(110, 231, 255, 0.8));
            animation: pulse-glow 2s infinite alternate;
        }
        
        @keyframes pulse-glow {
            0% { filter: drop-shadow(0 0 5px rgba(110, 231, 255, 0.6)); }
            100% { filter: drop-shadow(0 0 15px rgba(110, 231, 255, 0.9)); }
        }

        .menu-icon-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-icon-btn {
            padding: 8px 12px;
            font-size: 0.85rem;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: auto;
            background: linear-gradient(145deg, #1a1a2e, #131323);
            border: 1px solid var(--border);
            color: var(--accent);
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            height: 40px;
            width: 40px;
        }

        .menu-icon-btn:hover {
            background: rgba(110, 231, 255, 0.1);
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(110, 231, 255, 0.2);
        }

        .menu-icon-btn.active {
            background: rgba(110, 231, 255, 0.15);
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(110, 231, 255, 0.3);
        }

        .history-item {
            padding: 12px 14px;
            margin-bottom: 8px;
            border-radius: 12px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item:hover {
            border-color: var(--accent);
            background: rgba(110, 231, 255, 0.05);
        }

        .history-item.active {
            background: rgba(110, 231, 255, 0.1);
            border-color: var(--accent);
        }

        .history-title {
            font-size: 0.9rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .history-date {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .history-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .history-item:hover .history-actions {
            opacity: 1;
        }

        .history-btn {
            padding: 6px;
            border-radius: 6px;
            background: transparent;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .history-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .user-options {
            padding: 16px;
            border-top: 1px solid var(--border);
            background: var(--bg-panel);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #4dd0e1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #000;
            font-size: 0.9rem;
            box-shadow: 0 0 10px rgba(110, 231, 255, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .user-status {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .user-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .user-action-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-radius: 10px;
            background: transparent;
            color: var(--text-primary);
            transition: all 0.2s;
            width: 100%;
            text-align: left;
        }

        .user-action-btn:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .user-action-btn .material-symbols-rounded {
            font-size: 1.2rem;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .chat-input-area {
            padding: 16px;
            border-top: 1px solid var(--border);
            background: var(--bg-core);
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 20px;
        }

        .welcome-icon {
            width: 100px;
            height: 100px;
            border-radius: 25px;
            background: linear-gradient(135deg, var(--accent), #4dd0e1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            box-shadow: 0 0 30px rgba(110, 231, 255, 0.6);
        }

        .welcome-title {
            font-size: 2.2rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .welcome-subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 30px;
            max-width: 400px;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            max-width: 400px;
            width: 100%;
        }

        .quick-action {
            padding: 16px;
            border-radius: 12px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .quick-action:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .quick-icon {
            color: var(--accent);
            margin-bottom: 8px;
            font-size: 1.3rem;
        }

        .quick-title {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .editor-tabs {
            display: flex;
            background: #0c0c16;
            border-bottom: 1px solid var(--border);
        }

        .editor-tab {
            padding: 10px 16px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .editor-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
            background: rgba(110, 231, 255, 0.05);
        }

        .editor-container {
            flex: 1;
            display: none;
            position: relative;
        }

        .editor-container.active {
            display: flex;
            flex-direction: column;
        }

        .editor-textarea {
            flex: 1;
            width: 100%;
            background: var(--code-bg);
            color: var(--text-primary);
            border: none;
            resize: none;
            padding: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            outline: none;
            line-height: 1.5;
            white-space: pre-wrap;
            overflow-wrap: break-word;
        }

        .editor-controls {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #141426;
        }

        .editor-stats {
            display: flex;
            gap: 16px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .editor-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .editor-buttons {
            display: flex;
            gap: 8px;
        }

        .auto-run-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .toggle-switch {
            position: relative;
            width: 24px;
            height: 14px;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #404058;
            transition: .4s;
            border-radius: 14px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 10px;
            width: 10px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--accent);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(10px);
        }

        .sandbox-checkbox {
            display: none;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 1024px) {
            .three-pane-layout {
                position: relative;
            }
            
            .history-pane, .code-pane {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 1000;
                background: var(--bg-core);
                border-right: none;
                border-bottom: none;
                overflow-y: auto;
            }
            
            .history-pane.active, .code-pane.active {
                display: flex;
            }
            
            .chat-pane {
                width: 100%;
                height: 100%;
                border-right: none;
            }
            
            @media (min-width: 768px) and (max-width: 1024px) {
                .history-pane, .code-pane {
                    width: 300px;
                    position: absolute;
                    top: 0;
                    height: 100%;
                    z-index: 100;
                }
                
                .history-pane.active {
                    left: 0;
                }
                
                .code-pane.active {
                    right: 0;
                    left: auto;
                }
                
                .chat-pane.active {
                    width: calc(100% - 300px);
                    margin-left: 300px;
                }
            }
            
            /* Reduced text size for history and code panes on mobile */
            .history-title {
                font-size: 0.8rem !important;
            }
            
            .history-date {
                font-size: 0.65rem !important;
            }
            
            .editor-tab {
                font-size: 0.7rem !important;
                padding: 8px 10px !important;
            }
            
            .editor-stat {
                font-size: 0.7rem !important;
            }
            
            .navbar-harsh-icon {
                font-size: 2.2rem !important;
            }
            
            .input-container {
                padding: 10px !important;
                border-radius: 12px !important;
            }
            
            #user-input {
                padding: 12px !important;
                font-size: 1rem !important;
                min-height: 50px !important;
                border-radius: 8px !important;
            }
            
            #send-btn {
                padding: 12px !important;
                border-radius: 8px !important;
                width: 50px !important;
                height: 50px !important;
            }
            
            #mic-btn, .input-container button:not(#send-btn) {
                padding: 10px !important;
                border-radius: 8px !important;
                width: 40px !important;
                height: 40px !important;
            }
            
            .pane-header {
                padding: 8px 12px !important;
                justify-content: space-between !important;
                gap: 4px !important;
            }
            
            .navbar-left-group,
            .navbar-center-group,
            .navbar-right-group {
                flex: 1 !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                gap: 4px !important;
            }
            
            .navbar-left-group {
                justify-content: flex-start !important;
            }
            
            .navbar-right-group {
                justify-content: flex-end !important;
            }
            
            .menu-icon-btn,
            .call-btn, 
            .maps-btn, 
            .alarm-btn, 
            .share-btn,
            .code-menu-btn,
            .tts-btn,
            .whatsapp-btn {
                width: 36px !important;
                height: 36px !important;
                padding: 6px !important;
                min-width: 36px !important;
                margin: 0 2px !important;
            }
            
            .navbar-center-buttons {
                gap: 4px !important;
            }
            
            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 8px;
                background: transparent;
                color: var(--text-primary);
                border: 1px solid var(--border);
                border-radius: 8px;
                cursor: pointer;
            }
            
            .mobile-menu-btn:hover {
                background: rgba(255, 255, 255, 0.05);
            }
            
            .mobile-close-btn {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 8px;
                background: transparent;
                color: var(--text-primary);
                border: 1px solid var(--border);
                border-radius: 8px;
                cursor: pointer;
                margin-right: 8px;
            }
            
            .mobile-close-btn:hover {
                background: rgba(255, 255, 255, 0.05);
            }
            
            .mobile-pane-header {
                background: #141426;
                border-bottom: 1px solid var(--border);
                padding: 12px 16px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-shrink: 0;
            }
            
            .editor-tabs {
                flex-wrap: wrap;
            }
            
            .editor-tab {
                padding: 8px 12px;
                font-size: 0.75rem;
            }
            
            .editor-controls {
                padding: 10px 12px;
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .editor-stats {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .editor-buttons {
                width: 100%;
                justify-content: space-between;
            }
            
            .history-item {
                padding: 10px 12px;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .btn-small {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            
            .welcome-screen {
                padding: 16px;
            }
            
            .welcome-icon {
                width: 80px;
                height: 80px;
            }
            
            .welcome-title {
                font-size: 1.8rem;
            }
            
            .welcome-subtitle {
                font-size: 1rem;
            }

            .user-message-container {
                max-width: 95% !important;
            }
            
            .user-message-bubble {
                border-radius: 10px !important;
                padding: 10px 12px !important;
            }
            
            .ai-content {
                padding: 10px 12px !important;
                border-radius: 10px;
                margin-top: 8px;
            }
        }

        /* Desktop */
        @media (min-width: 1025px) {
            .mobile-menu-btn {
                display: none !important;
            }
            .mobile-close-btn {
                display: none !important;
            }
            
            .navbar-left-group {
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .navbar-center-group {
                display: flex;
                gap: 8px;
                margin: 0 auto;
            }
            
            .navbar-right-group {
                display: flex;
                align-items: center;
                gap: 8px;
            }
        }

        @media (max-width: 480px) {
            .navbar-harsh-icon {
                font-size: 2rem !important;
            }
            
            .input-container {
                padding: 8px !important;
                border-radius: 10px !important;
            }
            
            #user-input {
                padding: 10px !important;
                font-size: 1.05rem !important;
                min-height: 55px !important;
                border-radius: 6px !important;
            }
            
            #send-btn {
                padding: 10px !important;
                border-radius: 6px !important;
                width: 45px !important;
                height: 45px !important;
            }
            
            #mic-btn, .input-container button:not(#send-btn) {
                padding: 8px !important;
                border-radius: 6px !important;
                width: 35px !important;
                height: 35px !important;
            }
            
            .welcome-title {
                font-size: 1.6rem;
            }
            
            .welcome-subtitle {
                font-size: 0.95rem;
            }

            .menu-icon-btn,
            .call-btn, 
            .maps-btn, 
            .alarm-btn, 
            .share-btn,
            .code-menu-btn,
            .tts-btn,
            .whatsapp-btn {
                width: 32px !important;
                height: 32px !important;
                padding: 4px !important;
                min-width: 32px !important;
                margin: 0 1px !important;
            }
            
            .user-message-container {
                max-width: 98% !important;
            }
            
            .user-message-bubble {
                border-radius: 8px !important;
                padding: 8px 10px !important;
            }
            
            .ai-content {
                padding: 8px 10px !important;
                border-radius: 8px;
            }
        }

        .image-holder {
            width: 400px;
            height: 400px;
            margin-bottom: 2rem;
            border-radius: 2rem;
            padding: 0.5rem;
            background: linear-gradient(to bottom right, var(--accent), #4dd0e1);
            box-shadow: 0 0 30px rgba(110, 231, 255, 0.6);
        }
        
        @media (max-width: 768px) {
            .image-holder {
                width: 300px;
                height: 300px;
            }
        }
        
        @media (max-width: 480px) {
            .image-holder {
                width: 250px;
                height: 250px;
            }
            
            .landing-card {
                padding: 1.5rem !important;
                border-radius: 24px !important;
            }
        }
        
        @media (max-width: 360px) {
            .image-holder {
                width: 200px;
                height: 200px;
            }
        }
        
        .start-button {
            background: var(--accent);
            color: #1a202c;
            transition: all 0.3s ease;
        }
        
        .start-button:hover {
            background: #10b981;
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.6);
            transform: scale(1.02);
        }

        .tts-btn {
            background: var(--bg-panel);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            height: 40px;
            width: 40px;
        }

        .tts-btn:hover {
            background: rgba(110, 231, 255, 0.1);
            color: var(--accent);
            border-color: var(--accent);
        }

        .tts-btn.active {
            background: rgba(110, 231, 255, 0.15);
            color: var(--accent);
            border-color: var(--accent);
            box-shadow: 0 0 10px rgba(110, 231, 255, 0.3);
        }
        
        .share-btn {
            background: var(--bg-panel);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            height: 40px;
            width: 40px;
        }

        .share-btn:hover {
            background: rgba(110, 231, 255, 0.1);
            color: var(--accent);
            border-color: var(--accent);
        }
        
        .maps-btn {
            background: var(--bg-panel);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            height: 40px;
            width: 40px;
        }

        .maps-btn:hover {
            background: rgba(66, 133, 244, 0.1);
            color: #4285f4;
            border-color: #4285f4;
        }
        
        .alarm-btn {
            background: var(--bg-panel);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            height: 40px;
            width: 40px;
        }

        .alarm-btn:hover {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
            border-color: #ffc107;
        }
        
        .harsh-icon-btn {
            background: transparent;
            color: var(--accent);
            border: none;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .harsh-icon-btn:hover {
            transform: scale(1.1);
        }
        
        .code-menu-btn {
            background: var(--bg-panel);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            height: 40px;
            width: 40px;
        }

        .code-menu-btn:hover {
            background: rgba(110, 231, 255, 0.1);
            color: var(--accent);
            border-color: var(--accent);
        }
        
        .hamburger-icon {
            display: flex;
            flex-direction: column;
            gap: 3px;
            width: 20px;
            height: 20px;
            justify-content: center;
            align-items: center;
        }
        
        .hamburger-line {
            width: 18px;
            height: 2px;
            background-color: currentColor;
            border-radius: 1px;
            transition: all 0.3s ease;
        }
        
        .menu-icon-btn.active .hamburger-line:nth-child(1) {
            transform: rotate(45deg) translate(4px, 4px);
        }
        
        .menu-icon-btn.active .hamburger-line:nth-child(2) {
            opacity: 0;
        }
        
        .menu-icon-btn.active .hamburger-line:nth-child(3) {
            transform: rotate(-45deg) translate(4px, -4px);
        }
        
        .call-btn {
            background: var(--bg-panel);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            height: 40px;
            width: 40px;
        }

        .call-btn:hover {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border-color: #10b981;
        }
        
        .landing-harsh-text {
            font-size: 5rem !important;
        }
        
        @media (max-width: 768px) {
            .landing-harsh-text {
                font-size: 4rem !important;
            }
        }
        
        @media (max-width: 480px) {
            .landing-harsh-text {
                font-size: 3rem !important;
            }
        }
        
        .rectangular-bubble {
            border-radius: 10px;
            padding: 12px 16px;
            margin: 8px 0;
            max-width: 100%;
        }
        
        .user-rectangular-bubble {
            background: var(--user-bubble);
            border: 1px solid #303040;
        }
        
        .ai-rectangular-bubble {
            background: rgba(110, 231, 255, 0.05);
            border: 1px solid rgba(110, 231, 255, 0.2);
        }
        
        /* WhatsApp Button */
        .whatsapp-btn {
            background: var(--bg-panel);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            height: 40px;
            width: 40px;
        }

        .whatsapp-btn:hover {
            background: rgba(37, 211, 102, 0.1);
            color: #25D366;
            border-color: #25D366;
        }
    </style>
</head>
<body onload="loadHistory()">

    <div id="landing-page" class="absolute inset-0 flex flex-col items-center justify-center p-4 z-50 bg-[--bg-core]">
        <div class="flex flex-col items-center p-10 landing-card w-full max-w-2xl animate-floatUp">
             <div class="image-holder">
                <img src="ai-generated-8959823_640.png" 
                     alt="HARSH Core" 
                     class="w-full h-full object-cover rounded-[1.5rem] bg-black">
             </div>

            <div class="flex flex-col items-center max-w-xs w-full">
                <h1 class="landing-harsh-text text-6xl md:text-7xl font-extrabold text-white tracking-tight mb-8 text-shadow-lg">HARSH</h1> 
                <button onclick="showMainApp()" class="start-button w-full flex items-center justify-center gap-3 px-8 py-4 rounded-xl text-xl font-bold shadow-2xl">
                    Start Session
                </button>
            </div>
        </div>
    </div>

    <div id="main-app" class="flex-1 flex w-full h-full relative hidden">
        <div class="three-pane-layout">
            <!-- History Pane (25%) -->
            <div class="history-pane">
                <div class="mobile-pane-header">
                    <div class="pane-title">
                        <span class="material-symbols-rounded navbar-icon">history_edu</span>
                        History
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="toggleMobilePane('history')" class="mobile-close-btn" title="Close">
                            <span class="material-symbols-rounded icon-enhanced">close</span>
                        </button>
                        <button onclick="startNewChat(true)" class="btn-small btn-primary" title="New Chat">
                            <span class="material-symbols-rounded icon-enhanced">add</span>
                            New
                        </button>
                    </div>
                </div>
                <div class="pane-content">
                    <div id="history-list" class="flex flex-col gap-2"></div>
                </div>
                
                <!-- User Options Section -->
                <div class="user-options">
                    <div class="user-profile">
                        <div class="user-avatar">U</div>
                        <div class="user-info">
                            <div class="user-name">User</div>
                            <div class="user-status">HARSH Connected</div>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="user-action-btn" onclick="exportAllChats()">
                            <span class="material-symbols-rounded icon-enhanced">download</span>
                            Export All Chats
                        </button>
                        <button class="user-action-btn" onclick="clearAllHistory()">
                            <span class="material-symbols-rounded icon-enhanced">delete</span>
                            Clear All History
                        </button>
                        <button class="user-action-btn" onclick="showAbout()">
                            <span class="material-symbols-rounded icon-enhanced">info</span>
                            About HARSH
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Pane (50%) -->
            <div class="chat-pane">
                <div class="pane-header">
                    <!-- Left group: HARSH icon and History button -->
                    <div class="navbar-left-group">
                        <!-- HARSH Icon -->
                        <button class="harsh-icon-btn" title="HARSH AI">
                            <span class="material-symbols-rounded navbar-harsh-icon">terminal</span>
                        </button>
                        
                        <!-- History button -->
                        <button onclick="toggleMobilePane('history')" class="menu-icon-btn" title="History" id="history-menu-btn">
                            <span class="material-symbols-rounded icon-enhanced">history</span>
                        </button>
                    </div>
                    
                    <!-- Center group: Call, Maps, Alarm, WhatsApp, Share -->
                    <div class="navbar-center-group">
                        <!-- Call Button -->
                        <button onclick="initiateCall()" class="call-btn" title="Make a Call">
                            <span class="material-symbols-rounded icon-enhanced">call</span>
                        </button>
                        <!-- Google Maps Button -->
                        <button onclick="openGoogleMaps()" class="maps-btn" title="Open Google Maps">
                            <span class="material-symbols-rounded icon-enhanced">map</span>
                        </button>
                        <!-- Alarm Button -->
                        <button onclick="setAlarm()" class="alarm-btn" title="Set Alarm">
                            <span class="material-symbols-rounded icon-enhanced">alarm</span>
                        </button>
                        <!-- WhatsApp Button -->
                        <button onclick="openWhatsApp()" class="whatsapp-btn" title="Open WhatsApp Web">
                            <span class="material-symbols-rounded icon-enhanced">chat</span>
                        </button>
                        <!-- Share Button -->
                        <button onclick="shareChat()" class="share-btn" title="Share Chat">
                            <span class="material-symbols-rounded icon-enhanced">share</span>
                        </button>
                    </div>
                    
                    <!-- Right group: Code/Hamburger and TTS button -->
                    <div class="navbar-right-group">
                        <!-- Code/Hamburger button -->
                        <button onclick="toggleMobilePane('code')" class="code-menu-btn" title="Code Editor" id="code-menu-btn">
                            <!-- Three lines hamburger icon -->
                            <div class="hamburger-icon">
                                <div class="hamburger-line"></div>
                                <div class="hamburger-line"></div>
                                <div class="hamburger-line"></div>
                            </div>
                        </button>
                        
                        <!-- TTS Button -->
                        <button onclick="toggleTTS()" class="tts-btn" title="Toggle Text-to-Speech" id="tts-btn">
                            <span class="material-symbols-rounded icon-enhanced" id="tts-icon">volume_up</span>
                        </button>
                    </div>
                </div>
                <div class="chat-container">
                    <div class="chat-messages">
                        <div id="welcome-screen" class="welcome-screen">
                            <div class="welcome-icon">
                                <span class="material-symbols-rounded text-white text-4xl">terminal</span>
                            </div>
                            <h1 class="welcome-title">Ready to Code.</h1>
                            <p class="welcome-subtitle">Ask me anything about development, algorithms, or complex queries.</p>
                            <div class="quick-actions">
                                <button onclick="fillInput('Create a responsive login card in HTML/CSS')" class="quick-action">
                                    <span class="material-symbols-rounded quick-icon">dashboard</span>
                                    <div class="quick-title">Web Development</div>
                                </button>
                                <button onclick="fillInput('Open Google')" class="quick-action">
                                    <span class="material-symbols-rounded quick-icon">search</span>
                                    <div class="quick-title">Open Google</div>
                                </button>
                            </div>
                        </div>
                        <div id="messages-list" class="flex flex-col gap-4"></div>
                    </div>
                    <div class="chat-input-area">
                        <div id="img-preview" class="img-preview-container flex items-center gap-3 p-3 mb-2 bg-[--bg-panel] border border-[--border] rounded-xl hidden">
                            <img id="preview-src" src="" class="w-10 h-10 rounded object-cover border border-zinc-700 flex-shrink-0">
                            <div class="flex flex-col min-w-0 flex-1"><div class="text-sm text-zinc-200 truncate font-medium" id="preview-name">image.png</div><div class="text-xs text-zinc-500" id="preview-details"></div></div>
                            <button onclick="clearImage()" class="p-1 text-zinc-500 hover:text-white flex-shrink-0"><span class="material-symbols-rounded text-base">close</span></button>
                        </div>
                        <div class="input-container flex items-end p-2 relative">
                            <button id="mic-btn" onclick="toggleSpeechRecognition()" class="p-3 text-zinc-400 hover:text-[--accent] hover:bg-white/5 rounded-xl transition-colors"><span class="material-symbols-rounded text-[22px]" id="mic-icon">mic</span></button>
                            <button onclick="document.getElementById('file-upload').click()" class="p-3 text-zinc-400 hover:text-white hover:bg-white/5 rounded-xl transition-colors"><span class="material-symbols-rounded text-[22px]">add_photo_alternate</span></button>
                            <input type="file" id="file-upload" class="hidden" accept="image/*" onchange="handleImage(this)">
                            <textarea id="user-input" rows="1" placeholder="" class="w-full bg-transparent text-zinc-200 px-3 py-3.5 outline-none resize-none max-h-[300px]" oninput="adjustHeight(this)" onkeydown="handleInputKey(event)"></textarea>
                            <div class="flex items-center gap-1 pb-1 pr-1">
                                <button id="send-btn" onclick="handleSend()" disabled class="p-3 bg-cyan-500 text-gray-900 rounded-xl flex items-center justify-center disabled:bg-zinc-800 disabled:text-zinc-600 transition-all hover:bg-cyan-400 shadow-md shadow-cyan-500/30">
                                    <span class="material-symbols-rounded text-[20px]" id="send-icon">arrow_upward</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Code Pane (25%) - Code/Editor -->
            <div class="code-pane">
                <div class="mobile-pane-header">
                    <div class="pane-title">
                        <span class="material-symbols-rounded code-editor-icon">developer_mode</span>
                        Code
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="toggleMobilePane('code')" class="mobile-close-btn" title="Close">
                            <span class="material-symbols-rounded icon-enhanced">close</span>
                        </button>
                        <button onclick="downloadSandbox()" class="btn-small btn-secondary" title="Download .html">
                            <span class="material-symbols-rounded icon-enhanced">download</span>
                            Save
                        </button>
                        <button onclick="clearSandbox()" class="btn-small btn-danger" title="Clear All">
                            <span class="material-symbols-rounded icon-enhanced">delete</span>
                            Clear
                        </button>
                    </div>
                </div>
                <div class="editor-tabs">
                    <button onclick="switchTab('html')" id="tab-html" class="editor-tab active">
                        <span class="material-symbols-rounded icon-enhanced">html</span>
                        HTML
                    </button>
                    <button onclick="switchTab('css')" id="tab-css" class="editor-tab">
                        <span class="material-symbols-rounded icon-enhanced">css</span>
                        CSS
                    </button>
                    <button onclick="switchTab('js')" id="tab-js" class="editor-tab">
                        <span class="material-symbols-rounded icon-enhanced">javascript</span>
                        JS
                    </button>
                </div>
                <div class="flex-1 overflow-hidden">
                    <div id="editor-html" class="editor-container active">
                        <textarea id="code-html" class="editor-textarea" placeholder="<!-- HTML goes here -->" oninput="updateCodeStats()"></textarea>
                    </div>
                    <div id="editor-css" class="editor-container">
                        <textarea id="code-css" class="editor-textarea" placeholder="/* CSS goes here */" oninput="updateCodeStats()"></textarea>
                    </div>
                    <div id="editor-js" class="editor-container">
                        <textarea id="code-js" class="editor-textarea" placeholder="// JavaScript goes here" oninput="updateCodeStats()"></textarea>
                    </div>
                </div>
                <div class="editor-controls">
                    <div class="editor-stats">
                        <div class="editor-stat" id="html-lines">HTML: 0</div>
                        <div class="editor-stat" id="css-lines">CSS: 0</div>
                        <div class="editor-stat" id="js-lines">JS: 0</div>
                    </div>
                    <div class="editor-buttons">
                        <div class="auto-run-toggle">
                            <label class="toggle-switch">
                                <input type="checkbox" id="auto-run-toggle" class="sandbox-checkbox">
                                <span class="toggle-slider"></span>
                            </label>
                            <span>Auto Run</span>
                        </div>
                        <button onclick="runCode()" class="run-btn">
                            <span class="material-symbols-rounded text-sm">play_arrow</span>
                            Run
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- JAVASCRIPT: CORE LOGIC ---

        const API_KEY = "AIzaSyAqf7bWWXdjp8yjDwp2DdjFxmJIs1wbkM0"; 
        const MODEL_NAME = "gemini-2.5-flash"; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
        
        let abortController = null, chatHistory = [], sidebarHistory = JSON.parse(localStorage.getItem('HARSH_ChatHistory') || '[]'), currentChatId = null, recognition = null;
        let ttsEnabled = true;
        let ttsVoice = null;
        let availableVoices = [];
        let hasIntroduced = localStorage.getItem('HARSH_HasIntroduced') === 'true' || false;
        let recentCalls = JSON.parse(localStorage.getItem('HARSH_RecentCalls') || '[]');
        
        // --- WHATSAPP FUNCTIONALITY ---
        
        function openWhatsApp() {
            const whatsappUrl = 'https://web.whatsapp.com';
            openLinkInNewTab(whatsappUrl);
            addMessage(`Opening WhatsApp Web...`, 'user', true);
            if (ttsEnabled) speakText("Opening WhatsApp Web.");
        }
        
        // --- GOOGLE MAPS AND ALARM FUNCTIONS ---
        
        function openGoogleMaps() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const mapsUrl = `https://www.google.com/maps?q=${lat},${lng}`;
                        openLinkInNewTab(mapsUrl);
                        addMessage(` Opening Google Maps at your current location...`, 'user', true);
                        if (ttsEnabled) speakText("Opening Google Maps at your current location.");
                    },
                    (error) => {
                        const mapsUrl = 'https://www.google.com/maps';
                        openLinkInNewTab(mapsUrl);
                        addMessage(` Opening Google Maps...`, 'user', true);
                        if (ttsEnabled) speakText("Opening Google Maps.");
                    }
                );
            } else {
                const mapsUrl = 'https://www.google.com/maps';
                openLinkInNewTab(mapsUrl);
                addMessage(` Opening Google Maps...`, 'user', true);
                if (ttsEnabled) speakText("Opening Google Maps.");
            }
        }
        
        function openLinkInNewTab(url) {
            const a = document.createElement('a');
            a.href = url;
            a.target = '_blank';
            a.rel = 'noopener noreferrer';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        function setAlarm() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                backdrop-filter: blur(10px);
            `;
            
            const now = new Date();
            const currentHour = now.getHours().toString().padStart(2, '0');
            const currentMinute = now.getMinutes().toString().padStart(2, '0');
            
            modal.innerHTML = `
                <div style="background: var(--bg-panel); border: 2px solid var(--accent); border-radius: 20px; padding: 20px; max-width: 95%; width: 400px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: var(--accent); font-size: 1.5rem; margin: 0;">Set Alarm</h2>
                        <button onclick="document.body.removeChild(this.parentElement.parentElement.parentElement)" 
                                style="background: transparent; color: var(--text-secondary); border: none; font-size: 1.5rem; cursor: pointer;">
                            
                        </button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px;">Alarm Time</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="time" id="alarm-time" value="${currentHour}:${currentMinute}" 
                                   style="flex: 1; padding: 12px; background: var(--bg-core); border: 2px solid var(--border); 
                                          border-radius: 10px; color: white; font-size: 1.2rem; font-family: 'JetBrains Mono', monospace;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px;">Alarm Label</label>
                        <input type="text" id="alarm-label" placeholder="Wake up, Meeting, etc." 
                               style="width: 100%; padding: 12px; background: var(--bg-core); border: 2px solid var(--border); 
                                      border-radius: 10px; color: white; font-size: 1rem;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px;">Alarm Sound</label>
                        <select id="alarm-sound" style="width: 100%; padding: 12px; background: var(--bg-core); border: 2px solid var(--border); 
                                border-radius: 10px; color: white; font-size: 1rem;" onchange="toggleCustomRingtoneInput()">
                            <option value="beep">Beep</option>
                            <option value="bell">Bell</option>
                            <option value="chime">Chime</option>
                            <option value="digital">Digital</option>
                            <option value="custom">Ringtone</option>
                        </select>
                    </div>
                    
                    <div id="custom-ringtone-container" style="margin-bottom: 20px; display: none;">
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px;">Custom Ringtone URL (MP3/OGG/WAV)</label>
                        <input type="text" id="custom-ringtone-url" placeholder="https://example.com/your-song.mp3" 
                               style="width: 100%; padding: 12px; background: var(--bg-core); border: 2px solid var(--border); 
                                      border-radius: 10px; color: white; font-size: 1rem;">
                        <div style="margin-top: 8px; color: var(--text-secondary); font-size: 0.8rem;">
                            Enter a direct URL to your favorite song or ringtone
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="document.body.removeChild(this.parentElement.parentElement.parentElement)" 
                                style="flex: 1; padding: 15px; background: transparent; color: var(--text-secondary); 
                                       border: 1px solid var(--border); border-radius: 10px; cursor: pointer; font-weight: bold;">
                            Cancel
                        </button>
                        <button onclick="saveAlarmWithCustomTone()" 
                                style="flex: 2; padding: 15px; background: var(--accent); color: black; 
                                       border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1.1rem;">
                             Set Alarm
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function toggleCustomRingtoneInput() {
            const soundSelect = document.getElementById('alarm-sound');
            const customContainer = document.getElementById('custom-ringtone-container');
            
            if (soundSelect.value === 'custom') {
                customContainer.style.display = 'block';
            } else {
                customContainer.style.display = 'none';
            }
        }
        
        function saveAlarmWithCustomTone() {
            const alarmTime = document.getElementById('alarm-time').value;
            const alarmLabel = document.getElementById('alarm-label').value || "Alarm";
            const alarmSound = document.getElementById('alarm-sound').value;
            const customRingtoneUrl = document.getElementById('custom-ringtone-url') ? document.getElementById('custom-ringtone-url').value : '';
            
            if (!alarmTime) {
                alert("Please select a time for the alarm.");
                return;
            }
            
            const [hours, minutes] = alarmTime.split(':').map(Number);
            const now = new Date();
            const alarmDate = new Date();
            alarmDate.setHours(hours, minutes, 0, 0);
            
            if (alarmDate < now) {
                alarmDate.setDate(alarmDate.getDate() + 1);
            }
            
            const timeUntilAlarm = alarmDate.getTime() - now.getTime();
            
            if (timeUntilAlarm < 60000) {
                alert("Alarm time must be at least 1 minute from now.");
                return;
            }
            
            setTimeout(() => {
                triggerAlarm(alarmLabel, alarmSound, customRingtoneUrl);
            }, timeUntilAlarm);
            
            const formattedTime = alarmDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const formattedDate = alarmDate.toLocaleDateString();
            
            const modal = document.querySelector('div[style*="position: fixed"][style*="z-index: 9999"]');
            if (modal) document.body.removeChild(modal);
            
            let soundText = alarmSound;
            if (alarmSound === 'custom' && customRingtoneUrl) {
                soundText = 'Custom Ringtone';
            }
            addMessage(` Alarm set for ${formattedTime} on ${formattedDate}: ${alarmLabel} (${soundText})`, 'user', true);
            if (ttsEnabled) speakText(`Alarm set for ${formattedTime}. ${alarmLabel}`);
        }
        
        function triggerAlarm(label, sound, customUrl = '') {
            if (Notification.permission === "granted") {
                new Notification(` Alarm: ${label}`, {
                    body: "Time's up!",
                    icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%23ffc107'/><text x='50' y='60' font-size='30' text-anchor='middle' fill='white'></text></svg>"
                });
            }
            
            let audioSrc = "";
            
            if (sound === 'custom' && customUrl) {
                audioSrc = customUrl;
            } else {
                switch(sound) {
                    case 'beep': audioSrc = 'https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3'; break;
                    case 'bell': audioSrc = 'https://assets.mixkit.co/sfx/preview/mixkit-classic-alarm-995.mp3'; break;
                    case 'digital': audioSrc = 'https://assets.mixkit.co/sfx/preview/mixkit-digital-clock-digital-alarm-buzzer-992.mp3'; break;
                    case 'chime': audioSrc = 'https://assets.mixkit.co/sfx/preview/mixkit-bell-notification-933.mp3'; break;
                    default: audioSrc = 'https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3';
                }
            }
            
            const audio = new Audio(audioSrc);
            audio.loop = true;
            
            audio.addEventListener('error', function(e) {
                console.error('Error loading audio:', e);
                if (sound === 'custom') {
                    audio.src = 'https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3';
                    audio.play();
                }
            });
            
            audio.play();
            
            const alarmModal = document.createElement('div');
            alarmModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.95);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(10px);
            `;
            
            alarmModal.innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <div style="width: 120px; height: 120px; margin: 0 auto 30px; border-radius: 50%; background: linear-gradient(135deg, #ffc107, #ff9800); display: flex; align-items: center; justify-content: center; animation: pulse 1.5s infinite;">
                        <span class="material-symbols-rounded" style="font-size: 3rem; color: white;">alarm</span>
                    </div>
                    <h2 style="color: white; font-size: 2rem; margin-bottom: 10px;"> ALARM!</h2>
                    <div style="color: #ffc107; font-size: 1.5rem; margin-bottom: 20px;">${label}</div>
                    <div style="color: var(--text-secondary); font-size: 1.2rem; margin-bottom: 30px;">${new Date().toLocaleTimeString()}</div>
                    <button onclick="stopAlarm(this)" style="padding: 15px 30px; background: var(--accent); color: black; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1.2rem;">
                        STOP ALARM
                    </button>
                </div>
                <style>
                    @keyframes pulse {
                        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
                        70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(255, 193, 7, 0); }
                        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
                    }
                </style>
            `;
            
            alarmModal.audio = audio;
            
            document.body.appendChild(alarmModal);
            window.currentAlarmModal = alarmModal;
        }
        
        function stopAlarm(btn) {
            if (window.currentAlarmModal) {
                if (window.currentAlarmModal.audio) {
                    window.currentAlarmModal.audio.pause();
                    window.currentAlarmModal.audio.currentTime = 0;
                }
                document.body.removeChild(window.currentAlarmModal);
                window.currentAlarmModal = null;
                addMessage("Alarm stopped.", 'user', true);
            }
        }
        
        // --- TTS SYSTEM ---
        
        function initTTS() {
            if ('speechSynthesis' in window) {
                speechSynthesis.onvoiceschanged = function() {
                    availableVoices = speechSynthesis.getVoices();
                    selectNaturalVoice();
                };
                
                availableVoices = speechSynthesis.getVoices();
                
                setTimeout(() => {
                    availableVoices = speechSynthesis.getVoices();
                    if (availableVoices.length === 0) {
                        speechSynthesis.getVoices();
                    }
                    selectNaturalVoice();
                }, 1000);
                
                setTimeout(() => {
                    availableVoices = speechSynthesis.getVoices();
                    selectNaturalVoice();
                }, 3000);
            }
        }

        function selectNaturalVoice() {
            if (!availableVoices || availableVoices.length === 0) return;
            
            const naturalVoiceKeywords = [
                'google', 'natural', 'premium', 'enhanced', 'neural', 
                'samantha', 'daniel', 'ava', 'moira', 'kyoko',
                'yuna', 'siri', 'alex', 'catherine', 'tom'
            ];
            
            let bestVoice = null;
            
            for (let voice of availableVoices) {
                const voiceName = voice.name.toLowerCase();
                for (let keyword of naturalVoiceKeywords) {
                    if (voiceName.includes(keyword)) {
                        bestVoice = voice;
                        ttsVoice = voice;
                        return;
                    }
                }
            }
            
            for (let voice of availableVoices) {
                const voiceName = voice.name.toLowerCase();
                if (voiceName.includes('us') || voiceName.includes('gb') || voiceName.includes('en')) {
                    bestVoice = voice;
                    ttsVoice = voice;
                    return;
                }
            }
            
            if (availableVoices.length > 0) {
                ttsVoice = availableVoices[0];
            }
        }

        function detectLanguage(text) {
            const hindiRegex = /[\u0900-\u097F]/;
            const hinglishWords = ['kaise', 'hai', 'ho', 'kya', 'kyun', 'main', 'tum', 'aap', 'mera', 'tera', 'hum', 'log', 'hai'];
            const lowerText = text.toLowerCase();
            
            if (hindiRegex.test(text)) {
                return 'hi-IN';
            }
            
            const words = lowerText.split(/\s+/);
            const hindiWordCount = words.filter(word => hinglishWords.includes(word)).length;
            const hinglishRatio = hindiWordCount / words.length;
            
            if (hinglishRatio > 0.2) {
                return 'hi-IN';
            }
            
            return 'en-US';
        }

        function speakText(text) {
            if (!ttsEnabled || !text || text.trim().length < 5) return;
            
            window.speechSynthesis.cancel();
            
            let cleanText = text
                .replace(/```[\s\S]*?```/g, '') 
                .replace(/`[^`]*`/g, '') 
                .replace(/\[.*?\]\(.*?\)/g, '')
                .replace(/#{1,6}\s*/g, '')
                .replace(/\*\*/g, '')
                .replace(/\*/g, '')
                .replace(/<[^>]*>/g, '')
                .replace(/\n+/g, '. ')
                .replace(/\s+/g, ' ')
                .trim();
            
            if (cleanText.length > 300) {
                cleanText = cleanText.substring(0, 300) + '...';
            }
            
            const lang = detectLanguage(cleanText);
            speakWithEnhancedTTS(cleanText, lang);
        }

        function speakWithEnhancedTTS(text, lang) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            utterance.text = text
                .replace(/\. /g, '.   ')
                .replace(/\? /g, '?   ')
                .replace(/! /g, '!   ')
                .replace(/, /g, ',  ')
                .replace(/; /g, ';  ');

            if (ttsVoice) {
                utterance.voice = ttsVoice;
            } else {
                const voices = speechSynthesis.getVoices();
                let naturalVoice = voices.find(v => 
                    v.name.toLowerCase().includes('natural') || 
                    v.name.toLowerCase().includes('google') ||
                    v.name.toLowerCase().includes('premium') ||
                    v.name.toLowerCase().includes('enhanced')
                );
                
                if (naturalVoice) {
                    utterance.voice = naturalVoice;
                }
            }
            
            utterance.onerror = function(event) {
                console.error('Speech synthesis error:', event.error);
                speakWithBasicTTS(text, lang);
            };
            
            setTimeout(() => {
                try {
                    speechSynthesis.speak(utterance);
                } catch (e) {
                    console.error('Speech synthesis failed:', e);
                    speakWithBasicTTS(text, lang);
                }
            }, 50);
        }

        function speakWithBasicTTS(text, lang) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            const sentences = text.match(/[^\.!\?]+[\.!\?]+/g) || [text];
            
            if (sentences.length > 1) {
                sentences.forEach((sentence, index) => {
                    setTimeout(() => {
                        const sentenceUtterance = new SpeechSynthesisUtterance(sentence.trim());
                        sentenceUtterance.lang = lang;
                        sentenceUtterance.rate = 1.0;
                        sentenceUtterance.pitch = 1.0;
                        speechSynthesis.speak(sentenceUtterance);
                    }, index * 1000);
                });
            } else {
                speechSynthesis.speak(utterance);
            }
        }

        function toggleTTS() {
            ttsEnabled = !ttsEnabled;
            const ttsBtn = document.getElementById('tts-btn');
            const ttsIcon = document.getElementById('tts-icon');
            
            if (ttsEnabled) {
                ttsBtn.classList.add('active');
                ttsIcon.textContent = 'volume_up';
                ttsBtn.title = 'Voice: ON (Natural)';
                setTimeout(() => {
                    speakText("Voice mode activated.");
                }, 300);
            } else {
                ttsBtn.classList.remove('active');
                ttsIcon.textContent = 'volume_off';
                ttsBtn.title = 'Voice: OFF';
                window.speechSynthesis.cancel();
            }
            
            localStorage.setItem('HARSH_TTS_Enabled', ttsEnabled.toString());
        }

        function loadTTSPreference() {
            const saved = localStorage.getItem('HARSH_TTS_Enabled');
            if (saved !== null) {
                ttsEnabled = saved === 'true';
                const ttsBtn = document.getElementById('tts-btn');
                const ttsIcon = document.getElementById('tts-icon');
                
                if (ttsEnabled) {
                    ttsBtn.classList.add('active');
                    ttsIcon.textContent = 'volume_up';
                    ttsBtn.title = 'Voice: ON (Natural)';
                } else {
                    ttsBtn.classList.remove('active');
                    ttsIcon.textContent = 'volume_off';
                    ttsBtn.title = 'Voice: OFF';
                }
            }
        }
        
        function isAskingAboutIdentity(text) {
            const lowerText = text.toLowerCase();
            const identityQuestions = [
                'who are you', 
                'what is your name',
                'what are you',
                'what should i call you',
                'your name',
                'what\'s your name',
                'who am i talking to',
                'what is your identity'
            ];
            
            return identityQuestions.some(question => lowerText.includes(question));
        }
        
        function initiateCall() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                backdrop-filter: blur(10px);
            `;
            
            modal.innerHTML = `
                <div style="background: var(--bg-panel); border: 2px solid var(--accent); border-radius: 20px; padding: 20px; max-width: 95%; width: 400px; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: var(--accent); font-size: 1.5rem; margin: 0;">Make a Call</h2>
                        <button onclick="document.body.removeChild(this.parentElement.parentElement.parentElement)" 
                                style="background: transparent; color: var(--text-secondary); border: none; font-size: 1.5rem; cursor: pointer;">
                            
                        </button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div id="call-number-display" style="width: 100%; padding: 15px; background: var(--bg-core); 
                              border: 2px solid var(--border); border-radius: 10px; color: white; font-size: 1.5rem; 
                              text-align: center; margin-bottom: 10px; letter-spacing: 2px; font-family: 'JetBrains Mono', monospace;">
                            +91
                        </div>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button onclick="addToCallNumber('1')" class="dial-btn" style="flex: 1; padding: 12px; background: var(--bg-core); border: 1px solid var(--border); border-radius: 8px; color: white; font-size: 1.2rem; cursor: pointer;">1</button>
                            <button onclick="addToCallNumber('2')" class="dial-btn" style="flex: 1; padding: 12px; background: var(--bg-core); border: 1px solid var(--border); border-radius: 8px; color: white; font-size: 1.2rem; cursor: pointer;">2</button>
                            <button onclick="addToCallNumber('3')" class="dial-btn" style="flex: 1; padding: 12px; background: var(--bg-core); border: 1px solid var(--border); border-radius: 8px; color: white; font-size: 1.2rem; cursor: pointer;">3</button>
                        </div>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button onclick="addToCallNumber('4')" class="dial-btn" style="flex: 1; padding: 12px; background: var(--bg-core); border: 1px solid var(--border); border-radius: 8px; color: white; font-size: 1.2rem; cursor: pointer;">4</button>
                            <button onclick="addToCallNumber('5')" class="dial-btn" style="flex: 1; padding: 12px; background: var(--bg-core); border: 1px solid var(--border); border-radius: 8px; color: white; font-size: 1.2rem; cursor: pointer;">5</button>
                            <button onclick="addToCallNumber('6')" class="dial-btn" style="flex: 1; padding: 12px; background: var(--bg-core); border: 1px solid var(--border); border-radius: 8px; color: white; font-size: 1.2rem; cursor: pointer;">6</button>
                        </div>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button onclick="addToCallNumber('7')" class="dial-btn" style="flex: 1; padding: 12px; background: var(--bg-core); border: 1px solid var(--border); border-radius: 8px; color: white; font-size: 1.2rem; cursor: pointer;">7</button>
                            <button onclick="addToCallNumber('8')" class="dial-btn" style="flex: 1; padding: 12px; background: var(--bg-core); border: 1px solid var(--border); border-radius: 8px; color: white; font-size: 1.2rem; cursor: pointer;">8</button>
                            <button onclick="addToCallNumber('9')" class="dial-btn" style="flex: 1; padding: 12px; background: var(--bg-core); border: 1px solid var(--border); border-radius: 8px; color: white; font-size: 1.2rem; cursor: pointer;">9</button>
                        </div>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button onclick="addToCallNumber('*')" class="dial-btn" style="flex: 1; padding: 12px; background: var(--bg-core); border: 1px solid var(--border); border-radius: 8px; color: white; font-size: 1.2rem; cursor: pointer;">*</button>
                            <button onclick="addToCallNumber('0')" class="dial-btn" style="flex: 1; padding: 12px; background: var(--bg-core); border: 1px solid var(--border); border-radius: 8px; color: white; font-size: 1.2rem; cursor: pointer;">0</button>
                            <button onclick="addToCallNumber('#')" class="dial-btn" style="flex: 1; padding: 12px; background: var(--bg-core); border: 1px solid var(--border); border-radius: 8px; color: white; font-size: 1.2rem; cursor: pointer;">#</button>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="clearCallNumber()" style="flex: 1; padding: 12px; background: #ff6b6b; border: none; border-radius: 8px; color: white; font-size: 1rem; cursor: pointer;">Clear</button>
                            <button onclick="backspaceCallNumber()" style="flex: 1; padding: 12px; background: #4dabf7; border: none; border-radius: 8px; color: white; font-size: 1rem; cursor: pointer;"></button>
                            <button onclick="deleteRecentCalls()" style="flex: 1; padding: 12px; background: #ff6b6b; border: none; border-radius: 8px; color: white; font-size: 1rem; cursor: pointer;">Delete</button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 10px;">Recent Calls:</div>
                        <div id="recent-calls-list" style="max-height: 150px; overflow-y: auto; background: var(--bg-core); border-radius: 8px; padding: 10px;">
                            ${getRecentCallsHTML()}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="document.body.removeChild(this.parentElement.parentElement.parentElement)" 
                                style="flex: 1; padding: 15px; background: transparent; color: var(--text-secondary); 
                                       border: 1px solid var(--border); border-radius: 10px; cursor: pointer; font-weight: bold;">
                            Cancel
                        </button>
                        <button onclick="processAdvancedCall()" 
                                style="flex: 2; padding: 15px; background: var(--accent); color: black; 
                                       border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1.1rem;">
                             Call Now
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentCallModal = modal;
            window.currentCallNumber = "+91";
        }
        
        function addToCallNumber(num) {
            if (!window.currentCallNumber) window.currentCallNumber = "+91";
            
            if (window.currentCallNumber.replace(/[^\d]/g, '').length >= 15) return;
            
            window.currentCallNumber += num;
            updateCallNumberDisplay();
        }
        
        function updateCallNumberDisplay() {
            const display = document.getElementById('call-number-display');
            if (display && window.currentCallNumber) {
                display.textContent = window.currentCallNumber;
            }
        }
        
        function clearCallNumber() {
            window.currentCallNumber = "+91";
            updateCallNumberDisplay();
        }
        
        function backspaceCallNumber() {
            if (!window.currentCallNumber || window.currentCallNumber.length <= 3) {
                window.currentCallNumber = "+91";
            } else {
                window.currentCallNumber = window.currentCallNumber.slice(0, -1);
            }
            updateCallNumberDisplay();
        }
        
        function deleteRecentCalls() {
            if (confirm("Are you sure you want to delete all recent calls?")) {
                recentCalls = [];
                localStorage.setItem('HARSH_RecentCalls', JSON.stringify(recentCalls));
                updateRecentCallsList();
                alert("Recent calls deleted.");
            }
        }
        
        function updateRecentCallsList() {
            const recentCallsList = document.getElementById('recent-calls-list');
            if (recentCallsList) {
                recentCallsList.innerHTML = getRecentCallsHTML();
            }
        }
        
        function getRecentCallsHTML() {
            if (!recentCalls || recentCalls.length === 0) {
                return '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No recent calls</div>';
            }
            
            let html = '';
            recentCalls.slice(0, 5).forEach(call => {
                const timeAgo = getTimeAgo(call.timestamp);
                html += `
                    <div style="padding: 8px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: bold; color: var(--text-primary);">${call.number}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">${timeAgo}  ${call.type}</div>
                        </div>
                        <button onclick="callRecentNumber('${call.number}')" style="background: transparent; border: 1px solid var(--accent); color: var(--accent); border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem;">
                            Call
                        </button>
                    </div>
                `;
            });
            return html;
        }
        
        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        }
        
        function callRecentNumber(number) {
            window.currentCallNumber = number;
            updateCallNumberDisplay();
        }
        
        function addToRecentCalls(number, type = 'outgoing') {
            const call = {
                number: number,
                type: type,
                timestamp: Date.now()
            };
            
            recentCalls.unshift(call);
            if (recentCalls.length > 10) recentCalls.pop();
            localStorage.setItem('HARSH_RecentCalls', JSON.stringify(recentCalls));
            updateRecentCallsList();
        }
        
        function processAdvancedCall() {
            const phoneNumber = window.currentCallNumber;
            
            if (!phoneNumber || phoneNumber === "+91") {
                alert("Please enter a phone number.");
                return;
            }
            
            const cleanNumber = phoneNumber.replace(/[^\d+]/g, '');
            
            if (cleanNumber.replace('+', '').length < 10) {
                alert("Please enter a valid phone number with at least 10 digits.");
                return;
            }
            
            addToRecentCalls(cleanNumber, 'outgoing');
            
            if (window.currentCallModal) {
                document.body.removeChild(window.currentCallModal);
                window.currentCallModal = null;
            }
            
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            addMessage(` Calling ${cleanNumber}...`, 'user', true);
            if (ttsEnabled) speakText(`Calling ${cleanNumber}`);
            
            if (isMobile) {
                const telLink = `tel:${cleanNumber}`;
                showCallingAnimation(cleanNumber);
                setTimeout(() => {
                    window.location.href = telLink;
                }, 1500);
            } else {
                showDesktopCallOptions(cleanNumber);
            }
        }
        
        function showCallingAnimation(number) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.95);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(10px);
            `;
            
            modal.innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <div style="width: 120px; height: 120px; margin: 0 auto 30px; border-radius: 50%; background: linear-gradient(135deg, #10b981, var(--accent)); display: flex; align-items: center; justify-content: center; animation: pulse 1.5s infinite;">
                        <span class="material-symbols-rounded" style="font-size: 3rem; color: white;">call</span>
                    </div>
                    <h2 style="color: white; font-size: 1.8rem; margin-bottom: 10px;">Calling...</h2>
                    <div style="color: var(--accent); font-size: 1.5rem; font-family: 'JetBrains Mono', monospace; margin-bottom: 30px;">${number}</div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="endCallAnimation()" style="padding: 12px 24px; background: #ef4444; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer;">
                            End Call
                        </button>
                        <button onclick="openDialer('${number}')" style="padding: 12px 24px; background: var(--accent); color: black; border: none; border-radius: 10px; font-weight: bold; cursor: pointer;">
                            Open Dialer
                        </button>
                    </div>
                </div>
                <style>
                    @keyframes pulse {
                        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
                        70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(16, 185, 129, 0); }
                        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
                    }
                </style>
            `;
            
            document.body.appendChild(modal);
            window.callAnimationModal = modal;
        }
        
        function endCallAnimation() {
            if (window.callAnimationModal) {
                document.body.removeChild(window.callAnimationModal);
                window.callAnimationModal = null;
                addMessage("Call ended.", 'user', true);
            }
        }
        
        function openDialer(number) {
            const telLink = `tel:${number}`;
            window.location.href = telLink;
        }
        
        function showDesktopCallOptions(number) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.95);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(10px);
            `;
            
            modal.innerHTML = `
                <div style="background: var(--bg-panel); border: 2px solid var(--accent); border-radius: 20px; padding: 30px; max-width: 90%; width: 500px;">
                    <h2 style="color: var(--accent); margin-bottom: 20px; font-size: 1.5rem; text-align: center;">Call ${number}</h2>
                    <div style="margin-bottom: 30px;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <button onclick="desktopCallAction('copy', '${number}')" style="padding: 15px; background: var(--bg-core); border: 1px solid var(--border); border-radius: 10px; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                <span class="material-symbols-rounded" style="font-size: 2rem; color: var(--accent);">content_copy</span>
                                <span>Copy Number</span>
                            </button>
                            <button onclick="desktopCallAction('skype', '${number}')" style="padding: 15px; background: var(--bg-core); border: 1px solid var(--border); border-radius: 10px; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                <span class="material-symbols-rounded" style="font-size: 2rem; color: #00AFF0;">video_call</span>
                                <span>Skype</span>
                            </button>
                            <button onclick="desktopCallAction('whatsapp', '${number}')" style="padding: 15px; background: var(--bg-core); border: 1px solid var(--border); border-radius: 10px; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                <span class="material-symbols-rounded" style="font-size: 2rem; color: #25D366;">chat</span>
                                <span>WhatsApp</span>
                            </button>
                            <button onclick="desktopCallAction('meet', '${number}')" style="padding: 15px; background: var(--bg-core); border: 1px solid var(--border); border-radius: 10px; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                <span class="material-symbols-rounded" style="font-size: 2rem; color: #00897B;">videocam</span>
                                <span>Google Meet</span>
                            </button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="document.body.removeChild(this.parentElement.parentElement)" style="padding: 12px 24px; background: transparent; color: var(--text-secondary); border: 1px solid var(--border); border-radius: 10px; cursor: pointer;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function desktopCallAction(action, number) {
            switch(action) {
                case 'copy':
                    navigator.clipboard.writeText(number);
                    alert(`Phone number ${number} copied to clipboard.`);
                    break;
                case 'skype':
                    window.open(`skype:${number}?call`, '_blank');
                    alert(`Opening Skype to call ${number}.`);
                    break;
                case 'whatsapp':
                    const whatsappNumber = number.replace('+', '');
                    window.open(`https://wa.me/${whatsappNumber}`, '_blank');
                    alert(`Opening WhatsApp to message ${number}.`);
                    break;
                case 'meet':
                    window.open(`https://meet.google.com/new`, '_blank');
                    alert(`Creating new Google Meet session.`);
                    break;
            }
            
            const modal = document.querySelector('div[style*="position: fixed"][style*="z-index: 10000"]');
            if (modal) document.body.removeChild(modal);
        }
        
        window.showMainApp = () => { 
            document.getElementById('landing-page').classList.add('hidden'); 
            document.getElementById('main-app').classList.remove('hidden'); 
            startNewChat(false); 
            initSandbox(); 
            
            if (!hasIntroduced && ttsEnabled) {
                setTimeout(() => {
                    speakText("I am HARSH, your personal AI assistant.");
                    hasIntroduced = true;
                    localStorage.setItem('HARSH_HasIntroduced', 'true');
                }, 1000);
            }
        };
        
        window.loadHistory = () => { 
            renderSidebarHistory(); 
            initSpeechRecognition();
            initTTS();
            loadTTSPreference();
            
            if ("Notification" in window && Notification.permission === "default") {
                Notification.requestPermission();
            }
        }
        
        function formatBytes(bytes, d=2) { 
            if(bytes===0)return'0 Bytes'; 
            const k=1024, s=['Bytes','KB','MB','GB','TB'], i=Math.floor(Math.log(bytes)/Math.log(k)); 
            return parseFloat((bytes/Math.pow(k,i)).toFixed(d<0?0:d))+' '+s[i]; 
        }
        
        window.adjustHeight = (el) => { 
            el.style.height='auto'; 
            el.style.height=Math.min(el.scrollHeight,300)+'px'; 
            document.getElementById('send-btn').disabled=!(el.value.trim()||document.getElementById('file-upload').files.length>0)||(abortController!==null); 
        }
        
        window.fillInput = (t) => { 
            const el=document.getElementById('user-input'); 
            el.value=t; 
            window.adjustHeight(el); 
            el.focus(); 
        }
        
        window.handleInputKey = (e) => { 
            if(e.key==='Tab'){
                e.preventDefault();
                const s=e.target.selectionStart;
                e.target.value=e.target.value.substring(0,s)+"  "+e.target.value.substring(e.target.selectionEnd);
                e.target.selectionStart=e.target.selectionEnd=s+2;
            } else if(e.key==='Enter'&&!e.shiftKey){
                e.preventDefault();
                window.handleSend();
            } 
        }
        
        window.handleImage = (i) => { 
            if(i.files&&i.files[0]){
                const f=i.files[0], r=new FileReader();
                r.onload=(e)=>{
                    document.getElementById('preview-src').src=e.target.result;
                    document.getElementById('preview-name').innerText=f.name;
                    document.getElementById('preview-details').innerText=`${f.type.split('/')[1].toUpperCase()}  ${formatBytes(f.size)}`;
                    document.getElementById('img-preview').classList.remove('hidden');
                    window.adjustHeight(document.getElementById('user-input'));
                };
                r.readAsDataURL(f);
            } 
        }
        
        window.clearImage = () => { 
            document.getElementById('file-upload').value=''; 
            document.getElementById('img-preview').classList.add('hidden'); 
            document.getElementById('preview-src').src=''; 
            window.adjustHeight(document.getElementById('user-input')); 
        }
        
        window.copyPrompt = (btn) => { 
            const txt = btn.closest('.user-message-container').querySelector('.user-prompt-text').getAttribute('data-raw-text');
            navigator.clipboard.writeText(txt).then(()=>{
                const o=btn.innerHTML;
                btn.innerHTML=`<span class="material-symbols-rounded text-sm">check</span> Copied`;
                setTimeout(()=>btn.innerHTML=o,2000);
            });
        }
        
        window.copyCode = (btn) => {
            const c = btn.closest('pre').querySelector('code').innerText;
            navigator.clipboard.writeText(c).then(()=>{
                const o=btn.innerHTML;
                btn.innerHTML=`<span class="material-symbols-rounded text-sm">check</span> Copied`;
                setTimeout(()=>btn.innerHTML=o,2000);
            });
        }
        
        window.downloadCode = (btn) => {
            const pre=btn.closest('pre'), code=pre.querySelector('code').innerText, lang=pre.querySelector('.code-header span').innerText.toLowerCase();
            const extMap={'javascript':'js','python':'py','html':'html','css':'css','cpp':'cpp','c':'c','java':'java','json':'json'};
            const a=document.createElement('a'); 
            a.href=window.URL.createObjectURL(new Blob([code],{type:'text/plain'})); 
            a.download=`code.${extMap[lang]||'txt'}`; 
            document.body.appendChild(a); 
            a.click(); 
            document.body.removeChild(a);
        }
        
        function initSandbox() {
            document.getElementById('code-html').value = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Preview</title>
</head>
<body>
    <div class="container">
        <h1>Hello, Code!</h1>
        <p>Start coding to see your creation come to life.</p>
        <div id="app"></div>
    </div>
</body>
</html>`;
            
            document.getElementById('code-css').value = `body {
    font-family: 'Inter', sans-serif;
    margin: 0;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    min-height: 100vh;
}

.container {
    max-width: 800px;
    margin: 0 auto;
    text-align: center;
    padding: 40px 20px;
}

h1 {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    text-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

p {
    font-size: 1.2rem;
    opacity: 0.9;
}`;
            
            document.getElementById('code-js').value = `// JavaScript code goes here
console.log('Code initialized!');

// Example: Update the app div content
document.addEventListener('DOMContentLoaded', function() {
    const app = document.getElementById('app');
    if (app) {
        app.innerHTML = '<p> JavaScript is working!</p>';
    }
});`;
            
            updateCodeStats();
        }

        function updateCodeStats() {
            const htmlLines = document.getElementById('code-html').value.split('\n').length;
            const cssLines = document.getElementById('code-css').value.split('\n').length;
            const jsLines = document.getElementById('code-js').value.split('\n').length;
            
            document.getElementById('html-lines').textContent = `HTML: ${htmlLines}`;
            document.getElementById('css-lines').textContent = `CSS: ${cssLines}`;
            document.getElementById('js-lines').textContent = `JS: ${jsLines}`;
            
            if (document.getElementById('auto-run-toggle').checked) {
                runCode();
            }
        }

        function switchTab(tab) {
            ['html', 'css', 'js'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.remove('active');
                document.getElementById(`editor-${t}`).classList.remove('active');
            });
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`editor-${tab}`).classList.add('active');
        }
        
        function openPreviewTab() {
            const html = document.getElementById('code-html').value;
            const css = document.getElementById('code-css').value;
            const js = document.getElementById('code-js').value;
            
            const content = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HARSH Code Preview</title>
    <style>${css}</style>
</head>
<body>
    ${html}
    <script>${js}<\/script>
</body>
</html>`;
            
            const newWindow = window.open();
            newWindow.document.write(content);
            newWindow.document.close();
        }

        function clearSandbox() {
            if (confirm('Clear all code in the code editor?')) {
                document.getElementById('code-html').value = '';
                document.getElementById('code-css').value = '';
                document.getElementById('code-js').value = '';
                updateCodeStats();
            }
        }

        function runCode() {
            openPreviewTab();
        }

        window.downloadSandbox = () => {
            const html = document.getElementById('code-html').value;
            const css = document.getElementById('code-css').value;
            const js = document.getElementById('code-js').value;
            const content = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>${css}</style></head><body>${html}<script>${js}<\/script></body></html>`;
            const blob = new Blob([content], {type: 'text/html'});
            const a = document.createElement('a'); 
            a.href = URL.createObjectURL(blob); 
            a.download = 'harsh_code.html'; 
            document.body.appendChild(a); 
            a.click(); 
            document.body.removeChild(a);
        }

        window.loadToSandbox = (btn) => {
            const pre = btn.closest('pre');
            const code = pre.querySelector('code').innerText;
            const lang = pre.querySelector('.code-header span').innerText.toLowerCase();
            
            if (lang === 'html') { 
                document.getElementById('code-html').value = code; 
                switchTab('html'); 
            } else if (lang === 'css') { 
                document.getElementById('code-css').value = code; 
                switchTab('css'); 
            } else if (lang.includes('script') || lang === 'js' || lang === 'javascript') { 
                document.getElementById('code-js').value = code; 
                switchTab('js'); 
            }
            
            const originalHtml = btn.innerHTML;
            btn.innerHTML = `<span class="material-symbols-rounded text-sm">check_circle</span> Loaded`;
            setTimeout(() => btn.innerHTML = originalHtml, 1500);
            
            updateCodeStats();
        }

        function isWebsiteCommand(text) {
            const lowerText = text.toLowerCase().trim();
            const websiteMap = {
                'youtube': 'https://youtube.com',
                'google': 'https://google.com',
                'twitter': 'https://twitter.com',
                'facebook': 'https://facebook.com',
                'instagram': 'https://instagram.com',
                'netflix': 'https://netflix.com',
                'amazon': 'https://amazon.com',
                'github': 'https://github.com',
                'whatsapp': 'https://web.whatsapp.com',
                'telegram': 'https://web.telegram.org',
                'gmail': 'https://gmail.com',
                'linkedin': 'https://linkedin.com',
                'reddit': 'https://reddit.com',
                'discord': 'https://discord.com',
                'spotify': 'https://spotify.com',
                'wikipedia': 'https://wikipedia.org',
                'hotstar': 'https://hotstar.com',
                'primevideos': 'https://primevideo.com',
                'pikashow': 'https://pikashow.org.pk',
                'zee5': 'https://zee5.com',
                'sonyliv': 'https://sonyliv.com',
                'jio cinema': 'https://jiocinema.com',
                'mx player': 'https://mxplayer.in',
                'voot': 'https://voot.com',
                'twitch': 'https://twitch.tv',
                'tiktok': 'https://tiktok.com',
                'pinterest': 'https://pinterest.com',
                'snapchat': 'https://snapchat.com',
                'zoom': 'https://zoom.us',
                'dropbox': 'https://dropbox.com',
                
                'flipkart': 'https://flipkart.com',
                'meesho': 'https://meesho.com',
                'myntra': 'https://myntra.com',
                'ajio': 'https://ajio.com',
                'snapdeal': 'https://snapdeal.com',
                'olx': 'https://olx.in',
                'quikr': 'https://quikr.com',
                'bigbasket': 'https://bigbasket.com',
                'grofers': 'https://grofers.com',
                'dunzo': 'https://dunzo.com',
                'paytm': 'https://paytm.com',
                'phonepe': 'https://phonepe.com',
                'gpay': 'https://pay.google.com',
                'bookmyshow': 'https://bookmyshow.com',
                'airtel': 'https://airtel.in',
                'jiomart': 'https://jiomart.com',
                'tataneu': 'https://tatadigital.com',
                'byjus': 'https://byjus.com',
                'unacademy': 'https://unacademy.com',
                'ola': 'https://ola.com',
                'swiggy': 'https://swiggy.com',
                'zomato': 'https://zomato.com',
                'uber': 'https://uber.com',
                'makemytrip': 'https://makemytrip.com',
                'irctc': 'https://irctc.co.in',
                'cricbuzz': 'https://cricbuzz.com',
                'hotmail': 'https://outlook.com',
                'indiamart': 'https://indiamart.com',
                'gaana': 'https://gaana.com',
                'wynk': 'https://wynk.in'
            };
            
            for (const [key, url] of Object.entries(websiteMap)) {
                if (lowerText === key || lowerText === `open ${key}` || lowerText === `go to ${key}` || lowerText === `visit ${key}`) {
                    return url;
                }
            }
            
            if (lowerText.includes('.com') || lowerText.includes('.org') || lowerText.includes('.net') || lowerText.includes('.in') || lowerText.includes('.io')) {
                let url = lowerText;
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                return url;
            }
            
            return null;
        }

        window.toggleMobilePane = (pane) => {
            const paneElement = document.querySelector(`.${pane}-pane`);
            const btn = document.getElementById(`${pane}-menu-btn`);
            
            if (paneElement.classList.contains('active')) {
                paneElement.classList.remove('active');
                if (btn) btn.classList.remove('active');
            } else {
                document.querySelectorAll('.history-pane.active, .code-pane.active').forEach(el => {
                    el.classList.remove('active');
                });
                document.querySelectorAll('.menu-icon-btn').forEach(b => b.classList.remove('active'));
                
                paneElement.classList.add('active');
                if (btn) btn.classList.add('active');
            }
        }
        
        function addMessage(text, role, save, final=false) {
            const list=document.getElementById('messages-list'), div=document.createElement('div');
            div.className=`flex w-full ${role==='user'?'justify-end':'justify-start'} msg-anim`;
            if(save) chatHistory.push({role:role==='ai-model'?'model':role,text:text});
            
            if(role==='user'){
                div.innerHTML=`
                    <div class="max-w-[85%] md:max-w-[75%] user-message-container">
                        <div class="prompt-header flex items-center justify-between px-4 py-2 text-xs border border-b-0 border-[--border] rounded-t-xl">
                            <span class="font-medium text-zinc-400 flex items-center gap-1">
                                <span class="material-symbols-rounded text-sm">person</span> You
                            </span>
                            <button onclick="copyPrompt(this)" class="hover:text-white flex items-center gap-1 transition-colors text-zinc-400">
                                <span class="material-symbols-rounded text-sm">content_copy</span> Copy
                            </button>
                        </div>
                        <div class="user-message-bubble px-5 py-3 rounded-bl-lg rounded-br-lg rounded-tl-lg max-w-full leading-relaxed font-mono text-[0.9rem] user-prompt-text" data-raw-text="${text.replace(/"/g,'&quot;')}">
                            ${text.replace(/\n/g,'<br>')}
                        </div>
                    </div>`;
            } else if(role==='ai-error'){ 
                div.innerHTML=`<div class="p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400 text-sm">Error: ${text}</div>`;
            } else if(role==='ai-model' && final){ 
                const b=createAIBubbleStructure(text); 
                b.querySelector('#ai-loader')?.remove(); 
                list.appendChild(b); 
                streamResponse(b.querySelector('.ai-content'),text,true); 
                return; 
            } else if(role==='ai-model') {
                const b=createAIBubbleStructure(text); 
                list.appendChild(b); 
                return;
            }
            
            list.appendChild(div); 
            scrollToBottom();
        }
        
        window.handleSend = async () => {
            const inp = document.getElementById('user-input'), fileInp = document.getElementById('file-upload'), text = inp.value.trim();
            if(abortController){abortController.abort();return;} 
            if(!text&&fileInp.files.length===0)return;
            document.getElementById('welcome-screen').style.display='none';
            inp.value=''; 
            window.adjustHeight(inp);
            
            if (isAskingAboutIdentity(text)) {
                const identityResponse = "I am HARSH, your personal AI assistant. I'm here to help you with coding, development, and any technical questions. I can assist you with writing code, explaining concepts, debugging, and much more.";
                addMessage(identityResponse, 'ai-model', true);
                if (ttsEnabled) speakText("I am HARSH, your personal AI assistant.");
                return;
            }
            
            const websiteUrl = isWebsiteCommand(text);
            if (websiteUrl) {
                openLinkInNewTab(websiteUrl);
                addMessage(`Opening ${websiteUrl}...`, 'user', true);
                if (ttsEnabled) speakText(`Opening ${websiteUrl}`);
                return;
            }
            
            abortController = new AbortController();
            const btn=document.getElementById('send-btn'), icon=document.getElementById('send-icon');
            icon.innerText='stop'; 
            btn.classList.replace('bg-cyan-500','bg-red-500'); 
            btn.classList.replace('hover:bg-cyan-400','hover:bg-red-600'); 
            btn.disabled=false;
            
            let parts=[], userMsg=text;
            if(fileInp.files.length>0){
                userMsg+=` [Image: ${fileInp.files[0].name}]`;
                const b64 = await new Promise(r=>{
                    const rd=new FileReader();
                    rd.onload=()=>r(rd.result.split(',')[1]);
                    rd.readAsDataURL(fileInp.files[0]);
                });
                parts.push({inlineData:{data:b64,mimeType:fileInp.files[0].type}});
            }
            addMessage(userMsg,'user',true); 
            if(text)parts.push({text:text});
            
            const {contentDiv,loader} = createAIBubble(); 
            window.clearImage();
            
            try {
                const history = chatHistory.filter(m=>m.role!=='ai-error').map(m=>({role:m.role==='user'?'user':'model',parts:[{text:m.text}]}));
                history.push({role:'user',parts:parts});
                const res = await fetch(API_URL, {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    signal:abortController.signal,
                    body:JSON.stringify({contents:history,generationConfig:{temperature:0.7}})
                });
                if(!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json(); 
                loader.remove();
                if(data.candidates?.[0]?.content){
                    const aiText = data.candidates[0].content.parts[0].text;
                    await streamResponse(contentDiv, aiText); 
                    addMessage(aiText,'ai-model',true);
                    
                    if (ttsEnabled) {
                        speakText(aiText);
                    }
                    
                    saveChatSession(chatHistory.length===2?userMsg.substring(0,20)+'...':(sidebarHistory.find(s=>s.id===currentChatId)?.title||"Chat"));
                } else { 
                    contentDiv.innerHTML="<span class='text-orange-400'>No response.</span>"; 
                    addMessage("No response.",'ai-error',true); 
                }
            } catch(e) { 
                loader.remove(); 
                if(e.name!=='AbortError'){
                    contentDiv.innerHTML=`<div class="text-red-400">Error: ${e.message}</div>`;
                    addMessage(e.message,'ai-error',true);
                } 
            } finally { 
                abortController=null; 
                resetBtn(); 
                window.adjustHeight(inp); 
                inp.focus(); 
            }
        }
        
        function resetBtn() { 
            const btn=document.getElementById('send-btn'),icon=document.getElementById('send-icon'); 
            icon.innerText='arrow_upward'; 
            btn.classList.replace('bg-red-500','bg-cyan-500'); 
            btn.classList.replace('hover:bg-red-600','hover:bg-cyan-400'); 
        }
        
        function createAIBubbleStructure(text="") {
            const d=document.createElement('div'); 
            d.className='flex gap-4 w-full max-w-5xl msg-anim';
            d.innerHTML=`
                <div class="w-9 h-9 flex-shrink-0 rounded-full ai-avatar flex items-center justify-center mt-1 shadow-lg">
                    <span class="material-symbols-rounded text-white text-sm">terminal</span>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="font-medium text-sm text-zinc-300 mb-1">HARSH</div>
                    <div class="thinking-badge" id="ai-loader">
                        <span>Processing</span>
                        <div class="flex gap-1">
                            <div class="dot-pulse"></div>
                            <div class="dot-pulse"></div>
                            <div class="dot-pulse"></div>
                        </div>
                    </div>
                    <div class="prose text-zinc-200 ai-content rectangular-bubble ai-rectangular-bubble">${text}</div>
                </div>`;
            return d;
        }
        
        function createAIBubble() { 
            const list=document.getElementById('messages-list'), d=createAIBubbleStructure(); 
            list.appendChild(d); 
            scrollToBottom(); 
            return {contentDiv:d.querySelector('.ai-content'),loader:d.querySelector('#ai-loader')}; 
        }
        
        async function streamResponse(el, text, isFinal=false) {
            if(!isFinal) {
                const tokens = marked.lexer(text);
                let current=[]; 
                for(let i=0;i<tokens.length;i++){
                    current.push(tokens[i]);
                    if(tokens[i].type!=='space'&&tokens[i].type!=='text'){
                        el.innerHTML=marked.parser(current); 
                        scrollToBottom(); 
                        if(!abortController)break; 
                        await new Promise(r=>setTimeout(r,5)); 
                    }
                }
                el.innerHTML=marked.parser(tokens);
            } else { 
                el.innerHTML=marked.parse(text); 
            }
            
            el.querySelectorAll('pre code').forEach(block => {
                hljs.highlightElement(block);
                const pre = block.parentElement;
                if(!pre.querySelector('.code-header')) {
                    const lang = block.className.replace('language-','')||'Text';
                    const hdr = document.createElement('div');
                    hdr.className = 'code-header';
                    
                    let runBtn = '';
                    if(['html', 'css', 'javascript', 'js'].includes(lang.toLowerCase())) {
                        runBtn = `<button onclick="loadToSandbox(this)" class="mr-3 hover:text-[--accent] flex items-center gap-1 transition-colors" title="Load into Code Editor"><span class="material-symbols-rounded text-sm">input</span> Run</button>`;
                    }

                    hdr.innerHTML = `<span class="uppercase font-bold text-xs">${lang}</span><div class="flex items-center">${runBtn}<button onclick="downloadCode(this)" class="mr-3 hover:text-green-400 flex items-center gap-1 transition-colors"><span class="material-symbols-rounded text-sm">download</span></button><button onclick="copyCode(this)" class="hover:text-white flex items-center gap-1 transition-colors"><span class="material-symbols-rounded text-sm">content_copy</span> Copy</button></div>`;
                    pre.insertBefore(hdr, block);
                }
            });
            renderMathInElement(el, {delimiters:[{left:"$$",right:"$$",display:true},{left:"$",right:"$",display:false}]});
            scrollToBottom();
        }
        
        function scrollToBottom(){
            const c=document.getElementById('messages-list');
            c.parentElement.scrollTo({top:c.scrollHeight,behavior:'smooth'});
        }
        
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const micBtn = document.getElementById('mic-btn');
            if (!SpeechRecognition) { 
                console.warn('Web Speech API not supported.'); 
                micBtn.style.display = 'none'; 
                return null; 
            }
            recognition = new SpeechRecognition(); 
            recognition.continuous = false; 
            recognition.interimResults = true; 
            recognition.lang = 'en-US';
            const i=document.getElementById('user-input'), micIcon=document.getElementById('mic-icon');
            recognition.onstart=()=>{ 
                micIcon.innerText='mic_off'; 
                micBtn.classList.add('text-red-400'); 
                i.placeholder='...Listening...'; 
                i.focus(); 
            };
            recognition.onresult=(e)=>{ 
                let final='', interim=''; 
                for(let x=e.resultIndex; x<e.results.length; ++x) { 
                    if(e.results[x].isFinal) final+=e.results[x][0].transcript; 
                    else interim+=e.results[x][0].transcript; 
                } 
                i.value = final||interim; 
                window.adjustHeight(i); 
            };
            recognition.onerror=(e)=>{ 
                console.error(e); 
                recognition.stop(); 
                alert('Speech error: ' + e.error); 
            };
            recognition.onend=()=>{ 
                micIcon.innerText='mic'; 
                micBtn.classList.remove('text-red-400'); 
                i.placeholder=''; 
                if(i.value.trim()!=='') window.handleSend(); 
            };
            return recognition;
        }
        
        window.toggleSpeechRecognition = () => { 
            if(!recognition) recognition = initSpeechRecognition(); 
            if(recognition) document.getElementById('mic-icon').innerText==='mic' ? recognition.start() : recognition.stop(); 
        };

        function generateChatId(){return 'chat-'+Date.now();}
        
        function renderSidebarHistory(){
            const l=document.getElementById('history-list');
            l.innerHTML=''; 
            const s=sidebarHistory.slice(-10).reverse();
            if(s.length===0){
                l.innerHTML='<div class="px-4 py-2 text-sm text-zinc-600 text-center">No recent chats.</div>';
                return;
            }
            s.forEach(x=>{
                const i=document.createElement('div'); 
                i.className=`history-item ${x.id===currentChatId?'active':''}`;
                i.onclick=()=>loadChatSession(x.id);
                
                const date = new Date(x.timestamp);
                const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                
                i.innerHTML=`
                    <div class="flex-1">
                        <div class="history-title">${x.title||"Code Session"}</div>
                        <div class="history-date">${formattedDate}</div>
                    </div>
                    <div class="history-actions">
                        <button onclick="deleteChatSession(event,'${x.id}')" class="history-btn" title="Delete">
                            <span class="material-symbols-rounded text-sm">delete</span>
                        </button>
                    </div>
                `;
                l.appendChild(i);
            });
        }
        
        window.startNewChat = (save=true) => { 
            abortController=null; 
            currentChatId=generateChatId(); 
            chatHistory=[]; 
            document.getElementById('messages-list').innerHTML=''; 
            document.getElementById('welcome-screen').style.display='flex'; 
            window.fillInput(''); 
            renderSidebarHistory(); 
        }
        
        function saveChatSession(t) { 
            if(chatHistory.length===0)return; 
            const idx=sidebarHistory.findIndex(s=>s.id===currentChatId); 
            const sess={id:currentChatId,title:t,messages:chatHistory,timestamp:Date.now()}; 
            idx>-1?sidebarHistory[idx]=sess:sidebarHistory.push(sess); 
            localStorage.setItem('HARSH_ChatHistory',JSON.stringify(sidebarHistory)); 
            renderSidebarHistory(); 
        }
        
        window.loadChatSession = (id) => { 
            const s=sidebarHistory.find(x=>x.id===id); 
            if(s){ 
                if(abortController)abortController.abort(); 
                currentChatId=s.id; 
                chatHistory=s.messages; 
                document.getElementById('messages-list').innerHTML=''; 
                document.getElementById('welcome-screen').style.display='none'; 
                s.messages.forEach(m=>addMessage(m.text,m.role==='model'?'ai-model':m.role,false,true)); 
                scrollToBottom(); 
            } 
        }
        
        window.deleteChatSession = (e,id) => { 
            e.stopPropagation(); 
            sidebarHistory=sidebarHistory.filter(s=>s.id!==id); 
            id===currentChatId?startNewChat(false):renderSidebarHistory(); 
        }
        
        window.shareChat = () => { 
            navigator.share?navigator.share({title:'HARSH',url:window.location.href}):alert('Use Copy Link.'); 
        }

        window.exportAllChats = () => {
            const dataStr = JSON.stringify(sidebarHistory, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'harsh-chats.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alert("All chats exported successfully!");
        }

        window.clearAllHistory = () => {
            if (confirm("Are you sure you want to delete ALL chat history? This action cannot be undone.")) {
                sidebarHistory = [];
                localStorage.removeItem('HARSH_ChatHistory');
                startNewChat(false);
                alert("All chat history has been cleared.");
            }
        }

        window.showAbout = () => {
            alert("HARSH is a powerful AI assistant with integrated code editor, designed for developers and creators. It features voice, code execution sandbox, and supports multiple languages including English and Hindi. It can open 50 websites, and has a real Quantum core.");
        }
        
        document.addEventListener('DOMContentLoaded',()=>{
            if(document.getElementById('user-input'))window.adjustHeight(document.getElementById('user-input'));
        });
    </script>
</body>
</html>